## ワークフローのサンプル

### 開発開始

まず新しい機能を作り始めるときは、ブランチを切ります。



```
$ git checkout master
$ git checkout -b topic_A
$ (commit...commit...commit)
$ git checkout master
$ git merge --no-ff topic_A
```

#### developブランチの扱い

トピックブランチの開発が終わり、自動テストで十分テストできたら、
次のステップはdevelopment環境へのデプロイです。
開発したトピックブランチをdevelopブランチにマージし、デプロイします。
developブランチももちろんmasterから切ります。

```
$ git checkout develop
$ git merge topic_A
$ git push origin develop
$ cap dev deploy          # 例えばcapを使う場合
```

developブランチは、開発者全員からトピックブランチを頻繁にマージされる、総受けブランチです。
この段階でマージされるコミットは、どれだけ汚くても構いません。
試行錯誤のコミットやfixとしか書かれていないコミットメッセージでも全然問題ありません。
どんどんデプロイしていきましょう。

開発を続けていくと、developブランチは非常に汚いブランチになります。
こうなった場合は、綺麗サッパリ作り直しましょう。
リモートのdevelopブランチを消し、もう一度masterから作り直します。
作りなおしたdevelopブランチに、トピックブランチを歴史改変で整理してからもう一度マージすれば、
今度は以前より綺麗なdevelopブランチになります。

```
$ git push origin :develop    # 空白のブランチで:
$ git checkout master
$ git checkout -b develop
$ git push origin develop     # masterからdevelopを切り直してリモートブランチに
$ git merge topic_A ; git merge topic_B ...
$ git push origin develop
```

developブランチを作り直したいきっかけは他にも、
リリース予定のブランチだけをマージしたdevelopを作ったり、
リリース直後に次の開発のためにmasterから切り直して綺麗サッパリしたり、
頻繁にあると思います。

#### developブランチはどこにもマージしはいけない

次はいよいよ本番への反映です。
開発したトピックブランチをmasterにマージして本番デプロイをすることになります。
リリースのタイミングは会社やプロジェクトによって様々だと思います。

頻繁に本番リリースが許されている会社の場合、
開発が終わったトピックブランチ一つをmasterにマージして、
すぐにデプロイするという方法が取れます。
この場合、ほとんど他の人との調整をしなくて済むので、問題が起こることは非常に稀です。

1イテレーション(例えば1週間)に1回、定期リリースをするような運用方法の場合、
1回のリリースに複数の人がトピックブランチを持ち寄ることになります。
全員のトピックブランチのマージが上手く行かない事や、
単体ブランチのテストは上手く行っているが全部合わせた時のテストが失敗する場合があります。
もし直接masterにマージしていたら、masterに一瞬テストが落ちるという状態が発生してしまい、
あまり良くない状態だと言えます。

これを避けるためには、いったんリリース予定のトピックブランチを全て集めた、
**releaseブランチ** を作るといいでしょう。
もちろんreleaseブランチはmasterから切ります。
すべてのトピックブランチをreleaseブランチにマージし、
コンフリクトが起こったら解決し、自動テストが全部通るのを確認します。
テストが通ったら、新たにmasterから切り直したdevelopブランチにreleaseブランチをマージし、
開発環境にデプロイして動作確認します。
動作確認が正常に終了したら、releaseブランチをmasterブランチにマージし(この時コンフリクトは絶対起きません)、
本番環境にデプロイします。
